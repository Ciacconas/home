#!/usr/bin/python3
#    _____ _     ____  ____  ____  ____  _____
#   /    // \   /  _ \/  __\/  _ \/  __\/__ __\
#   |  __\| |   | / \||  \/|| / \||  \/|  / \
#   | |   | |_/\| |-|||  __/| \_/||    /  | |
#   \_/   \____/\_/ \|\_/   \____/\_/\_\  \_/
#

# Imports
import os
import time
import sys, tty, termios
import ueberzug.lib.v0 as ueberzug
import subprocess

def is_int(x):
    try:
        int(x)
        return True
    except:
        return False


EXTS = {".png", ".jpg", ".svg"}
ARGS = [arg for arg in sys.argv[1:] if not is_int(arg) and os.path.splitext(arg)[1] in EXTS]
XYWH = [int(arg) for arg in sys.argv[1:] if is_int(arg)]

X = 0
if len(XYWH) > 0:
    X = int(XYWH[0])

Y = 0
if len(XYWH) > 1:
    Y = int(XYWH[1])

WX=100
if len(XYWH) > 2:
    WX = int(XYWH[2])

WY=WX//2
if len(XYWH) > 3:
    WY = int(XYWH[3])

# Functions
def wait_for_any_input():
    """ from https://stackoverflow.com/questions/510357/python-read-a-single-character-from-the-user"""
    fd = sys.stdin.fileno()
    old_settings = termios.tcgetattr(fd)
    try:
        tty.setraw(sys.stdin.fileno())
        ch = sys.stdin.read(1)
    finally:
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
    return ch

def draw(path):
    if path.endswith(".svg"):
        return show_svg(path)
    with ueberzug.Canvas() as c:
        demo = c.create_placement('ueberzug', x=X, y=Y, width=WX, height=WY, scaler="contain")
        demo.path = path
        demo.visibility = ueberzug.Visibility.VISIBLE
        return wait_for_any_input()

def show_svg(path):
    with open(os.devnull, "w") as devnull:
        subprocess.call(["inkscape", path, "-e", "/tmp/ubz.png"], stdout=devnull, stderr=devnull)
    return draw("/tmp/ubz.png")


if __name__ == "__main__":
    key = ""
    idx = 0
    while key != "q" and key != "\x1b": # Esc
        if key in {"j"}:
            idx = (idx + 1)%len(ARGS)
        elif key in {"k"}:
            idx = (idx - 1)%len(ARGS)
        key = draw(ARGS[idx])
    print(repr(key))

