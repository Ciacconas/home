#!/usr/bin/env bash
#    _____ _     ____  ____  ____  ____  _____
#   /    // \   /  _ \/  __\/  _ \/  __\/__ __\
#   |  __\| |   | / \||  \/|| / \||  \/|  / \
#   | |   | |_/\| |-|||  __/| \_/||    /  | |
#   \_/   \____/\_/ \|\_/   \____/\_/\_\  \_/

PREVIEW=""

# ueberzug preview:
< <(</dev/tty stty size) read TERMINAL_LINES TERMINAL_COLUMNS
X=$((TERMINAL_COLUMNS - COLUMNS - 2))
Y=$((TERMINAL_LINES - LINES - 1))
>"${FZF_UEBERZUG_FIFO}" declare -A -p cmd=( \
    [action]=add [identifier]="preview" \
    [x]="${X}" [y]="${Y}" \
    [width]="${COLUMNS}" [height]="${LINES}" \
    [scaler]=forced_cover [scaling_position_x]=0.5 [scaling_position_y]=0.5 \
    [path]="")

[[ ! -z $1 ]] && FILENAME=$1 || exit 1
[[ ! -z $2 ]] && LINESSHOWN=$2 || LINESSHOWN=51

if [[ $FILENAME == *.png || $FILENAME == *.jpg ]]; then
    PREVIEW="$FILENAME"

    # ueberzug preview:
    < <(</dev/tty stty size) read TERMINAL_LINES TERMINAL_COLUMNS
    X=$((TERMINAL_COLUMNS - COLUMNS - 2))
    Y=$((TERMINAL_LINES - LINES - 1))
    >"${FZF_UEBERZUG_FIFO}" declare -A -p cmd=( \
        [action]=add [identifier]="preview" \
        [x]="${X}" [y]="${Y}" \
        [width]="${COLUMNS}" [height]="${LINES}" \
        [scaler]=forced_cover [scaling_position_x]=0.5 [scaling_position_y]=0.5 \
        [path]="${FILENAME}")

elif [[ $FILENAME == *.py ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=python -O ansi --force)
elif [[ $FILENAME == *.ipynb ]]; then
    which jupyter &> /dev/null
    if [[ $? == 0 ]]; then
        PREVIEW=$(jupyter nbconvert $FILENAME --to python --stdout 2> /dev/null | highlight -O ansi --force)
    else
        PREVIEW=$FILENAME
    fi
elif [[ $FILENAME == *.htm* ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=html -O ansi --force)
elif [[ $FILENAME == *.md ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=markdown -O ansi --force)
elif [[ $FILENAME == *.pdf ]]; then
    which pdftotext &> /dev/null
    if [[ $? == 0 ]]; then
        PREVIEW=$(pdftotext -q $FILENAME -)
    else
        PREVIEW=$FILENAME
    fi
elif [[ $FILENAME == *.bash ||  $FILENAME == *.sh ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=bash -O ansi --force)
else
    PREVIEW=$(cat $FILENAME | highlight -O ansi --force)
fi

if [[ -z $PREVIEW ]]; then
    PREVIEW=$FILENAME
fi

# printed preview
printf "$PREVIEW"

