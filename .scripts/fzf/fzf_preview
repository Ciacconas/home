#!/usr/bin/env bash
#    _____ _     ____  ____  ____  ____  _____
#   /    // \   /  _ \/  __\/  _ \/  __\/__ __\
#   |  __\| |   | / \||  \/|| / \||  \/|  / \
#   | |   | |_/\| |-|||  __/| \_/||    /  | |
#   \_/   \____/\_/ \|\_/   \____/\_/\_\  \_/

PREVIEW=""

[[ ! -z $1 ]] && FILENAME=$1 || exit 1
[[ ! -z $2 ]] && LINESSHOWN=$2 || LINESSHOWN=51

# ueberzug preview:
< <(</dev/tty stty size) read TERMINAL_LINES TERMINAL_COLUMNS
X=$((TERMINAL_COLUMNS - COLUMNS - 2))
Y=$((TERMINAL_LINES - LINES - 1))
>"${FZF_UEBERZUG_FIFO}" declare -A -p cmd=( \
    [action]=add [identifier]="preview" \
    [x]="${X}" [y]="${Y}" \
    [width]="${COLUMNS}" [height]="${LINES}" \
    [scaler]=forced_cover [scaling_position_x]=0.5 [scaling_position_y]=0.5 \
    [path]="")

[[ $FILENAME == *.mp4 ]] && ffmpeg -y -i $FILENAME -ss 00:00:01.000 -vframes 1 /tmp/fzf_ueberzug_preview.png &> /dev/null && FILENAME=/tmp/fzf_ueberzug_preview.png
[[ $FILENAME == *.svg ]] && inkscape "$FILENAME" -e /tmp/fzf_ueberzug_preview.png &> /dev/null && FILENAME=/tmp/fzf_ueberzug_preview.png

if [[ $FILENAME == *.png || $FILENAME == *.jpg || $FILENAME == *.jpeg ]]; then
    PREVIEW="$FILENAME"
    # ueberzug preview:
    if true; then
    < <(</dev/tty stty size) read TERMINAL_LINES TERMINAL_COLUMNS
    X=$((TERMINAL_COLUMNS - COLUMNS - 3))
    Y=$((TERMINAL_LINES - LINES - 1))
    [ "$CURSORPOSITION" -lt "$Y" ] && Y="$CURSORPOSITION"
    >"${FZF_UEBERZUG_FIFO}" declare -A -p cmd=( \
        [action]=add [identifier]="preview" \
        [x]="${X}" [y]="${Y}" \
        [width]="${COLUMNS}" [height]="${LINES}" \
        [scaler]=forced_cover [scaling_position_x]=0.5 [scaling_position_y]=0.5 \
        [path]="${FILENAME}")
    fi &
elif [[ $FILENAME == *.py ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=python -O ansi --force)
elif [[ $FILENAME == *.ipynb ]]; then
    which jupyter &> /dev/null
    if [[ $? == 0 ]]; then
        PREVIEW=$(jupyter nbconvert $FILENAME --to python --stdout 2> /dev/null | highlight -O ansi --force)
    else
        PREVIEW=$FILENAME
    fi
elif [[ $FILENAME == *.htm* ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=html -O ansi --force)
elif [[ $FILENAME == *.md ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=markdown -O ansi --force)
elif [[ $FILENAME == *.pdf ]]; then
    which pdftotext &> /dev/null
    if [[ $? == 0 ]]; then
        PREVIEW=$(pdftotext -q $FILENAME -)
    else
        PREVIEW=$FILENAME
    fi
elif [[ $FILENAME == *.bash ||  $FILENAME == *.sh ]]; then
    PREVIEW=$(cat $FILENAME | highlight --src-lang=bash -O ansi --force)
else
    PREVIEW=$(cat $FILENAME | highlight -O ansi --force)
fi

if [[ -z $PREVIEW ]]; then
    PREVIEW=$FILENAME
fi

# printed preview
printf "$PREVIEW"

