#!/usr/bin/env bash
#    _____ _     ____  ____  ____  ____  _____
#   /    // \   /  _ \/  __\/  _ \/  __\/__ __\
#   |  __\| |   | / \||  \/|| / \||  \/|  / \
#   | |   | |_/\| |-|||  __/| \_/||    /  | |
#   \_/   \____/\_/ \|\_/   \____/\_/\_\  \_/

rm -f $HOME/.local/share/dwm_autostart.log
touch $HOME/.local/share/dwm_autostart.log
rm -f $HOME/.local/share/dwm_autostart.errors.log
touch $HOME/.local/share/dwm_autostart.errors.log
start(){
    pidof $1 || $@ >> $HOME/.local/share/dwm_autostart.log 2>> $HOME/.local/share/dwm_autostart.errors.log &
}

# enable hotkeys
start sxhkd

# set wallpaper
start wallpaper current

# enable transparent windows
if [ -f "$HOME/.config/picom/blur-kern" ]; then
    start picom --no-fading-openclose --blur-kern=$(cat $HOME/.config/picom/blur-kern)
else
    start picom --no-fading-openclose
fi

# update xrdb database
[ -f ~/.Xresources ] && start xrdb ~/.Xresources

# start nextcloud client
start nextcloud

# export your desired screenlayout with `arandr`
start default_screenlayout

# notifications
start dunst

# network manager applet (in most right corner of the screen)
start nm-applet

# automatically lock screen after 10 minutes
start xautolock -time 10 -locker validate_and_lock_screen

# make the mouse invisible after a brief period of not using it.
start unclutter

# conky dashboards
start conky -c $HOME/.config/conky/conky.conf -x 60
start conky -c $HOME/.config/conky/conky.conf -x -1860
start conky -c $HOME/.config/conky/conky.conf -x -3780

# set cursor speed
# wrapped into loop, as sometimes this inexplicably stops working
while true; do
    xset r rate 200 45 &
    sleep 60
done &

# update dwm status bar every 10 seconds
while true; do
    sleep 2s
    dwm_status &> /dev/null &
    sleep 8s
done &

# check battery status every 10 minutes
while true; do
    sleep 10s
    battery=$(acpi -b 2> /dev/null)
    percentage=$(echo $battery |  sed 's/^.*, \([0-9]*\)%.*$/\1/g')
    if [[ $battery = *Discharging* && $percentage -lt 5 ]]; then
        notify-send --urgency=CRITICAL "battery low" "ï‰„   $percentage%"
    fi
    sleep 550s
done &

# update weather report every hour
while true; do
    sleep 10s
    update_weather &> /dev/null  &
    sleep 3550s
done &

# sync joplin notes every hour
while true; do
    sleep 10s
    ln -f $HOME/.config/joplin/database.sqlite $HOME/.config/joplin/database.tui.sqlite
    joplin sync &> /dev/null
    ps -Af | grep joplin-desktop | grep -v grep &> /dev/null
    if [ $? -ne 0 ]; then # joplin GUI not running
        ps -Af | grep joplin | grep -v grep &> /dev/null
        if [ $? -ne 0 ]; then # joplin TUI not running
            ln -f $HOME/.config/joplin-desktop/database.sqlite $HOME/.config/joplin/database.sqlite
            joplin sync &> /dev/null
            ln -f $HOME/.config/joplin/database.tui.sqlite $HOME/.config/joplin/database.sqlite
        fi
    fi
    joplin sync &> /dev/null
    sleep 3550s
done &

